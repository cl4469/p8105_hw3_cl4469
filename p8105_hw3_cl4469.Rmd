---
title: "p8105_hw3_cl4469"
author: "Chen Liang"
date: "2023-10-07"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(patchwork)
library(ggplot2)
library(p8105.datasets)
```

```{r}
data("instacart")
```

```{r}
instacart %>% select(product_id) %>% distinct %>% count()

instacart %>% select(user_id, order_id) %>% distinct %>% count 
  
instacart %>% select(user_id) %>% distinct %>% count

```

```{r}
instacart |>
  group_by(aisle) |>
  summarize(n_obs=n()) |>
  arrange(desc(n_obs))

max(pull(instacart,aisle_id))
```
This is a table showing the number of items ordered from aisle. There are `r max(pull(instacart,aisle_id))` aisles.And the most items ordered from aisles are fresh vegetables and fresh fruits.

```{r}
instacart |>
  count(aisle) |>
  filter(n > 10000) |>
  mutate(aisle=fct_reorder(aisle, n)) |>
  ggplot(aes(x=aisle,y=n))+
  geom_point()+
  labs(
    title="Number of items ordered in each aisle",
    x="Aisle",
    y="Number of items (n)",
    caption = "Data from the instacart package")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        axis.text = element_text(size = 7.5) )
```
Here is a plot that shows the number of items ordered in each aisle. And aisles are ordered by ascending number of items.

```{r}
rank_3 <- instacart |> 
  filter(aisle %in% c("baking ingredients","dog food care","packaged vegetables fruits")) |>
  group_by(aisle,product_name)|>
  summarise(n=n()) |>
  mutate(product_ranking=min_rank(desc(n))) |>
  filter(product_ranking < 2)

knitr::kable(rank_3, caption = "Most Popular Item in Each of The Aisles")
```
This table shows the three most popular items in aisles `baking ingredients`, `dog food care`, and `packaged vegetables fruits`, and includes the number of times each item is ordered.

```{r}
instacart |>
  filter(product_name %in% c("Pink Lady Apples","Coffee Ice Cream")) |>
  group_by(product_name, order_dow) |>
  summarise(mean_hour= mean(order_hour_of_day)) |>
  spread(key = order_dow, value = mean_hour) |>
  knitr::kable(caption = "Mean Hour of The Day 2 Items Are Ordered ", digits = 2)
```
This table shows the mean hour of the day at which Pink Lady Apples and Coffee Ice Cream are ordered on each day of the week. The result is a 2x7 table. There are 7 variables as column names ranging from 0 to 6, the row are the specific day in a week. The cell values are means of the hours of each day in a week. From this table, we can see Pink Lady Apples are generally purchased slightly earlier in the day than Coffee Ice Cream, with the exception of day 5.

## Problem 2

```{r}
data("brfss_smart2010")
```

#### Data cleaning:
```{r}
brfss_df=
  brfss_smart2010 |>
  janitor::clean_names() |>
  filter(topic=="Overall Health",
         response %in% c("Excellent", "Very good", "Good", "Fair", "Poor")) |>
  mutate(response = fct_relevel(response, "Poor", "Fair", "Good", "Very good", "Excellent"))

  
# which one is better? 
#mutate(response = fct_relevel(response, "Poor", "Fair", "Good", "Very good", "Excellent"))
#mutate(response = factor(response, ordered =TRUE, levels = c("Poor", "Fair", "Good", "Very Good", "Excellent")))

# mutate(response = factor(...)): This approach converts the "response" column into a completely new ordered factor variable. The resulting factor will have the specified levels and will be ordered as specified.
# mutate(response = fct_relevel(response, ...)): This approach doesn't change the factor's order but only reorders the levels within the existing factor. It can be used to change the order of levels without changing the data type from factor to a different data type.
```

```{r}
brfss_df |> 
  filter(year==2002 | year==2010) |>
  group_by(year,locationabbr,locationdesc) |>
  summarize(n=n()) |>
  count(locationabbr,name = "locations") %>% 
    filter(locations >= 7) %>% 
  pivot_wider(
    names_from = year,
    values_from = locations
  )
```
The table shows states observed equal or more than 7 times in both 2002 and 2010.There are 6 state have observed equal or more than 7 times in 2002, but 14 much more in 2010.

```{r}
brfss_df |> 
  filter(response == "Excellent") |>
  group_by(year,locationabbr) |>
  summarize(mean_data_value=mean(data_value,na.rm = TRUE)) |>
  ggplot(aes(x = year, y = mean_data_value, group = locationabbr,color = locationabbr)) + 
  geom_line()+ 
  labs(
    y = "Average of Data Value",
    title = "Spaghetti Plot: Average Value Over Time Within a State"
  ) +
  theme_minimal()
```

```{r}
brfss_df %>% 
  filter(response == "Excellent") %>% 
  group_by(year, locationabbr, locationdesc) %>% 
  summarize(
    ave_val = mean(data_value, na.rm = TRUE),
  ) %>% 
  ggplot(aes(x = year, y = ave_val)) + 
  geom_point() + 
  geom_line(aes(group = locationabbr))+
  labs(
    y="average of data value",
    title = "average value over time within a state"
  )
```

```{r}
data2006 <- brfss_df |>
  filter(year==2006 & locationabbr == "NY") |>
  ggplot(aes(x = locationdesc, y = data_value, fill = response)) + 
  geom_bar(stat = "identity", position = "fill" )+
  coord_flip()+
  labs(
    title = "2006 distribution of data value",
    y = "data value"
    )+
  theme(legend.position = "none")

data2010 <- brfss_df |>
  filter(year==2010 & locationabbr == "NY") |>
  ggplot(aes(x = locationdesc, y = data_value, fill = response)) + 
  geom_bar(stat = "identity", position = "fill" ) +
  coord_flip()+
  labs(
    title = "2010 distribution of data value",
    y = "data value"
    )+
  theme(legend.position = "none")

data2006 /data2010
```

```{r}
brfss_df |>
  filter(year %in% c(2006,2010),
         locationabbr == "NY") |>
  ggplot(aes(x = data_value, fill = response)) +
  geom_density(alpha = 0.5) +
  facet_grid(.~year) +
  theme(axis.text.x = element_text()) +
  labs(
    title = "Density Plots for 2006 and 2010",
    x = "Response",
    y = "Density",
    caption = "Data from BRFSS Dataset"
  )
```

```{r}
brfss_df |>
  filter(year %in% c(2006,2010),
         locationabbr == "NY") |>
  ggplot(aes(x = response, y = data_value)) +
  geom_boxplot(aes(fill = response)) +
  facet_grid(.~year) +
  theme(axis.text.x = element_text()) +
  labs(
    title = "Box Plots for 2006 and 2010",
    x = "Response",
    y = "Data_value",
    caption = "Data from BRFSS Dataset"
  )
```

## Problem 3

```{r}
accel_df <- read_csv("data/nhanes_accel.csv") |>
  janitor::clean_names() |>
  pivot_longer(
    min1:min1440,
    names_to = "min",
    names_prefix = "min",
    values_to = "mims"
    )
```

```{r}
covar_df <- read_csv("data/nhanes_covar.csv",skip = 4) |>
  janitor::clean_names() |>
  mutate(sex=ifelse(sex==1,"Male","Female"),
         sex = factor(sex, levels = c("Male", "Female")),
         education = case_match(education,
                                1 ~ "Less than high school",
                                2 ~ "High school equivalent",
                                3 ~ "More than high school"),
         education = factor(education, 
                            levels = c("Less than high school", "High school equivalent", "More than high school")))
```

```{r}
nhanes_df=
  left_join(accel_df,covar_df)|>
  drop_na(sex,age,bmi,education) |>
  filter(age >= 21)
```

Produce a reader-friendly table for the number of men and women in each education category, and create a visualization of the age distributions for men and women in each education category. Comment on these items.
```{r}
nhanes_df |>
  group_by(sex,education) |>
  summarize(n=n()) |>
  pivot_wider(
    names_from = education,
    values_from = n) |>
    knitr::kable()
```

```{r}
nhanes_df |> 
  ggplot(aes(x = education, y = age, color = sex)) + 
  geom_boxplot() +
  labs(title = "Age distribution for men and women", 
        x = "Education level",
        y = "Age")
```

Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant. Plot these total activities (y-axis) against age (x-axis); your plot should compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences.
```{r}
nhanes_df |>
  group_by(seqn,age,sex,education) |>
  summarize(total_activity=sum(mims)) |>
  ggplot(aes(x=age,y=total_activity,color=sex))+
  geom_point(alpha = .7) +
  geom_smooth(se = FALSE)+
  facet_grid(. ~ education) +
  labs(title="Total activities against age for males and females",
       x="Age",
       y="Total activities")
```

Accelerometer data allows the inspection activity over the course of the day. Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. Describe in words any patterns or conclusions you can make based on this graph; including smooth trends may help identify differences.

```{r}
nhanes_df |>
  mutate(min = as.numeric(min)) |>
  ggplot(aes(x=min,y=mims, color=sex))+
  geom_point(alpha=0.5)+
  geom_smooth()+
  facet_grid(. ~ education)+
  labs(title="24-Hour activity time courses",
       x="Minute of a day",
       y="Activity",
       caption = "Data from nhanes dataset")
```



